{% extends 'layout.html' %} 
{% block title %}Posts{% endblock %} 

{% block content %}
<h2>Posts Page</h2>
{% for post in post_details %}
	<div class="container">
		<div class="my-2 box">
			<form>
				<article class="media content-section">
					<div class="media-body">
						<div class="article-metadata">
							Post created by:&nbsp;&nbsp;<a class="mr-2" href="#">{{ post['username'] }}</a>
							on &nbsp;<small class="text-muted"> {{ post['datePosted'].strftime('%Y-%m-%d') }}</small>
						</div>
						<h2><a class="article-title" href="#">{{ post['title'] }}</a></h2>
						<p class="article-content">{{ post['content'] }}</p>
					</div>
				</article>
			</form>
			<hr>		
			<div class="btn-toolbar">
				{% if post['idUser'] == session['id'] %}
					<a href="/update/{{ post['idPost'] }}"><button type="button" class="btn btn-primary btn-sm mr-2">Update Post</button></a>
					<button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#exampleModal">Delete Post</button>
				{% endif %}	
			</div>
			<br>
			<article class="media content-section">
				<div class="media-body">
					<div class="article-metadata">
						{% for comment in commentsAdded[post['idPost']] %}
							{{ comment['context'] or "" }}&nbsp;
							<i onclick="myFunction(this)" class="fa fa-thumbs-up"></i>
							<br>
							<br>
							<b>Comment by:</b>&nbsp;&nbsp;<a class="mr-2" href="#">{{ comment['username'] }}</a>
							on &nbsp;<small class="text-muted">{{ comment['dateComment'].strftime('%Y-%m-%d') }}</small>&nbsp;
							&nbsp;
							<br>
							<br>
							{% if comment['idUser'] == session['id']%}
								<a href="/edit/{{ comment['idComment'] }}"><button type="submit" class="btn btn-primary btn-sm">Edit Comment</button></a>
							{% endif %}
							{% if post['idUser'] == session['id'] %}	
								<button class="btn btn-danger btn-sm deleteBtn" data-value="{{comment['idComment']}}">Delete Comment</button>
							{% endif %}	
							<br>
							<br>
							<div class="post-message-holder text-small center text-success"></div>
						{% endfor %}
					</div>
				</div>
			</article>
			<br>
			<a href="#myModal/posts/{{ post.idPost }}/comments" class="btn btn-sm btn-primary" data-toggle="modal">Add a comment</a>
			<div id="myModal/posts/{{ post.idPost }}/comments" class="modal fade">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title d-inline-block">Your comment</h5>
							<button type="button" class="close  d-inline-block" data-dismiss="modal">&times;</button>
						</div>
						<div class="modal-body">
							<form method="POST" action="{{url_for('postings.comments', id_post = post['idPost'])}}">
								<input type="hidden" name="idPost" value="{{ post.idPost }}">
								<div class="form-group">
									<label for="inputName">User: </label>
									<a class="mr-2" href="#">{{ username }}</a>
								</div>
								<div class="form-group">
									<label for="inputComment">Comments</label>
									<textarea class="form-control" id="inputComment" name="context" rows="5"></textarea>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
									<button type="submit" class="btn btn-primary">Send</button>
								</div>
							</form>
						</div>
					</div>
				</div>	
			</div>					

			<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLabel">Delete Post</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span></button>
							</div>
						<div class="modal-body">
							Are you sure you want to delete this post ?
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" data-dismiss="modal">NO</button>
							<a href="/delete/{{ post['idPost'] }}"><button type="button" class="btn btn-danger">YES</button></a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endfor %}
	
	<nav aria-label="Page navigation example">
		<ul class="pagination">
			<li class="page-item">
				{% if prev >= 1 %}
					<a class="page-link" href="/posts/page/{{ prev }}">Previous</a>
				{% endif %}
			</li>
			{% for i in range(pages) %}
				<li class="page-item">
				<a class="page-link" href="/posts/page/{{ i+1 }}">{{ i+1 }}</a>
			{% endfor %}
			</li>
			<li class="page-item">
				{% if next <= pages %}
			<a class="page-link" href="/posts/page/{{ next }}">Next</a>
				{% endif %}
			</li>
		</ul>
	</nav>


	<script>

		window.onload = () => {
			setClickListeners();
		}

		function setClickListeners() {
			const deleteCommentsBtnHolder = document.querySelectorAll( ".deleteBtn" );
			if ( deleteCommentsBtnHolder && deleteCommentsBtnHolder.length > 0 ) {
				for ( let item = 0; item < deleteCommentsBtnHolder.length; item++ ) {
					let btn = deleteCommentsBtnHolder[item];
					if ( btn == null ) { return false; }
					btn.addEventListener( 'click', ( element ) => { onDeletePressed( element ); } )
				}
			}
		}

		function onDeletePressed( action ) {
			
			if ( action.target.getAttribute( 'data-value' ) ) {
				// set this instance to that
				const that = this;

				let response =  new Promise( function( resolve, reject ) {
					// set the server request
					var xhttp = new XMLHttpRequest();
						xhttp.onreadystatechange = function() {
							if ( this.readyState == 4 && this.status == 200 ) {
								// convert the response from base64 and json to obj
								let response = JSON.parse( atob( this.responseText ) );
								// return the server error 
								if( response['error'] > 0 ){
									reject( { 'error':2, 'message':response['message'] } );
									return false;
								}

								resolve();
							}
						};
						xhttp.open( 'POST', `/deleteComments/${action.target.getAttribute( 'data-value' )}`,true );
						xhttp.send();

				} );

				response.then( () => {
					// set the response to holder
					setTimeout( ()=> {
						let messageHolder = document.querySelector( '.post-message-holder' );
						if ( messageHolder ) {
							messageHolder.classList.remove( 'text-danger');
							messageHolder.classList.add( 'text-success');
							messageHolder.innerHTML = response['message'];
						}
						window.location.reload();
					}, 500 );
				} ).catch( ( error ) => {
					let messageHolder = document.querySelector( '.post-message-holder' );
					if ( messageHolder ) {
						messageHolder.classList.add( 'text-danger');
						messageHolder.classList.remove( 'text-success');
						messageHolder.innerHTML = `ERROR::${ error['message']}`;
					}
				} );
			}
		}

	</script>

{% endblock %}